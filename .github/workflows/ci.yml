name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      CLAUDE_PROXY_EXE_PATCH: "1"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.12"
          cache: true

      - name: gofmt (verify)
        shell: bash
        run: |
          bad="$(gofmt -l .)"
          if [ -n "$bad" ]; then
            echo "gofmt required for:"
            echo "$bad"
            exit 1
          fi

      - name: Setup SSHD for integration tests (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo mkdir -p /run/sshd
          SSH_TEST_USER="ssh-test"
          if ! id -u "$SSH_TEST_USER" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash -p '$6$ci$WiNqQDjl.EMvmwex4uixbzCpYwPdZ5pjMhtV6AMb004JamOVMOgqYaNOYOgWVmv/1Eq9TSb.yuZ94xGrgVNuS/' "$SSH_TEST_USER"
          fi
          SSH_TEST_DIR="$(mktemp -d)"
          ssh-keygen -t ed25519 -N "" -f "$SSH_TEST_DIR/host_key"
          ssh-keygen -t ed25519 -N "" -f "$SSH_TEST_DIR/test_key"
          sudo install -d -m 700 -o "$SSH_TEST_USER" -g "$SSH_TEST_USER" "/home/$SSH_TEST_USER/.ssh"
          sudo install -m 600 -o "$SSH_TEST_USER" -g "$SSH_TEST_USER" "$SSH_TEST_DIR/test_key.pub" "/home/$SSH_TEST_USER/.ssh/authorized_keys"
          chmod 700 "$SSH_TEST_DIR"
          chmod 600 "$SSH_TEST_DIR/test_key" "$SSH_TEST_DIR/test_key.pub" "$SSH_TEST_DIR/host_key"
          cat > "$SSH_TEST_DIR/sshd_config" <<EOF
          Port 22222
          ListenAddress 127.0.0.1
          HostKey $SSH_TEST_DIR/host_key
          AuthorizedKeysFile /home/$SSH_TEST_USER/.ssh/authorized_keys
          PasswordAuthentication no
          ChallengeResponseAuthentication no
          KbdInteractiveAuthentication no
          UsePAM no
          PermitRootLogin no
          PubkeyAuthentication yes
          StrictModes no
          AllowTcpForwarding yes
          PermitOpen any
          PidFile $SSH_TEST_DIR/sshd.pid
          AllowUsers ${SSH_TEST_USER}
          LogLevel ERROR
          EOF
          sudo /usr/sbin/sshd -t -f "$SSH_TEST_DIR/sshd_config"
          sudo /usr/sbin/sshd -f "$SSH_TEST_DIR/sshd_config"
          for i in {1..20}; do
            if ssh -i "$SSH_TEST_DIR/test_key" -p 22222 \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o BatchMode=yes \
              "${SSH_TEST_USER}@127.0.0.1" exit; then
              break
            fi
            sleep 0.2
          done
          echo "SSH_TEST_ENABLED=1" >> "$GITHUB_ENV"
          echo "SSH_TEST_HOST=127.0.0.1" >> "$GITHUB_ENV"
          echo "SSH_TEST_PORT=22222" >> "$GITHUB_ENV"
          echo "SSH_TEST_USER=${SSH_TEST_USER}" >> "$GITHUB_ENV"
          echo "SSH_TEST_KEY=$SSH_TEST_DIR/test_key" >> "$GITHUB_ENV"

      - name: go vet
        run: go vet ./...

      - name: go test (with coverage)
        shell: bash
        run: |
          go test -coverprofile=coverage.out ./...

      - name: Resolve Claude release bucket
        shell: bash
        run: |
          set -euo pipefail
          info="$(scripts/claude_release_info.sh)"
          bucket="$(printf "%s\n" "$info" | awk -F= '/^gcs_bucket=/{print $2}')"
          if [ -z "$bucket" ]; then
            echo "Failed to resolve Claude release bucket" >&2
            exit 1
          fi
          echo "CLAUDE_PATCH_BUCKET=$bucket" >> "$GITHUB_ENV"

      - name: Load Claude patch version
        shell: bash
        run: |
          set -euo pipefail
          version="$(cat scripts/claude_patch_version.txt | tr -d '\r\n')"
          if [ -z "$version" ]; then
            echo "Missing Claude patch version in scripts/claude_patch_version.txt" >&2
            exit 1
          fi
          echo "CLAUDE_PATCH_VERSION=$version" >> "$GITHUB_ENV"

      - name: Claude patch smoke (macOS)
        if: runner.os == 'macOS'
        shell: bash
        env:
          CLAUDE_PATCH_TEST: "1"
        run: |
          go test ./internal/cli -run TestClaudePatchIntegration -count=1

      - name: Claude patch smoke (Linux)
        if: runner.os == 'Linux'
        shell: bash
        env:
          CLAUDE_PATCH_TEST: "1"
        run: |
          go test ./internal/cli -run TestClaudePatchIntegration -count=1

      - name: Claude patch smoke (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          CLAUDE_PATCH_TEST: "1"
        run: |
          go test ./internal/cli -run TestClaudePatchIntegration -count=1

      - name: Claude install+launch smoke (all platforms)
        shell: bash
        timeout-minutes: 15
        env:
          CLAUDE_INSTALL_TEST: "1"
        run: |
          set -euo pipefail
          for attempt in 1 2; do
            if go test ./internal/cli -run TestClaudeInstallLaunchIntegration -count=1; then
              exit 0
            fi
            if [ "$attempt" -eq 2 ]; then
              exit 1
            fi
            echo "Retrying Claude install+launch smoke after transient failure..."
            sleep 3
          done

      - name: go test -race (Linux only)
        if: runner.os == 'Linux'
        run: go test -race ./...

      - name: Coverage gate (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          threshold="25.0"
          total="$(go tool cover -func=coverage.out | awk '/^total:/ {gsub(/%/,"",$NF); print $NF}')"
          echo "Total coverage: ${total}% (threshold ${threshold}%)"
          awk -v total="$total" -v threshold="$threshold" 'BEGIN { if (total+0 < threshold+0) { printf("coverage %.2f%% < %.2f%%\n", total, threshold); exit 1 } }'

      - name: Upload coverage artifact (Linux only)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  linux-distro-smoke:
    name: Linux distro smoke (CentOS7/Rocky8/Ubuntu20.04)
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.12"
          cache: true

      - name: Build static linux-amd64 binary
        shell: bash
        run: |
          mkdir -p dist
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags "-s -w" -o dist/claude-proxy ./cmd/claude-proxy
          chmod +x dist/claude-proxy

      - name: Build linux install integration test binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go test ./internal/cli -c -o dist/claude_cli_test
          chmod +x dist/claude_cli_test

      - name: Smoke test in containers (doctor)
        shell: bash
        run: |
          set -euo pipefail
          for img in centos:7 rockylinux:8 ubuntu:20.04; do
            echo "==> $img"
            docker run --rm -v "$PWD/dist:/dist:ro" "$img" /dist/claude-proxy proxy doctor
          done

      - name: Smoke test in containers (Claude install+launch)
        shell: bash
        run: |
          set -euo pipefail
          for img in rockylinux:8 ubuntu:20.04; do
            echo "==> $img"
            docker run --rm \
              -v "$PWD/dist:/dist:ro" \
              -v "$PWD/scripts/ci:/ci:ro" \
              -e CLAUDE_INSTALL_TEST=1 \
              -e CI=true \
              "$img" bash /ci/container_claude_install_launch_smoke.sh
          done

      - name: Download prebuilt CentOS7 glibc compat bundle
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GLIBC_COMPAT_TAG: "glibc-compat-v2.31"
          GLIBC_COMPAT_BUNDLE: "glibc-2.31-centos7-runtime-x86_64.tar.xz"
        run: |
          set -euo pipefail
          mkdir -p dist/glibc-compat
          if ! gh release download "$GLIBC_COMPAT_TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --pattern "$GLIBC_COMPAT_BUNDLE" \
            --pattern "$GLIBC_COMPAT_BUNDLE.sha256" \
            --dir dist/glibc-compat; then
            echo "Failed to download prebuilt glibc compat bundle (${GLIBC_COMPAT_TAG})." >&2
            echo "Run workflow 'Build glibc compat bundle' to publish the bundle first." >&2
            exit 1
          fi
          (
            cd dist/glibc-compat
            sha256sum -c "$GLIBC_COMPAT_BUNDLE.sha256"
          )

      - name: Smoke test in CentOS7 (Claude startup via auto glibc patch)
        shell: bash
        timeout-minutes: 15
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$PWD/dist:/dist:ro" \
            -v "$PWD/dist/glibc-compat/glibc-2.31-centos7-runtime-x86_64.tar.xz:/bundle.tar.xz:ro" \
            -v "$PWD/scripts/glibc:/scripts:ro" \
            centos:7 bash /scripts/test_centos7_clp_autopatch.sh

